<!doctype html>
<html lang="pl"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Zmień hasło</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <!-- jeśli chcesz tło/feel jak profil, to możesz też dołączyć profile.css -->
    <link rel="stylesheet" th:href="@{/css/profile.css}">
    <link rel="stylesheet" th:href="@{/css/change-password.css}">
</head>

<body class="profile-body page-bg">

<header class="topbar">
    <div class="container topbar__inner">
        <a class="brand" th:href="@{/home}">
            <img class="brand__logo" th:src="@{/img/logo.jpg}" alt="YourMed"/>
        </a>

        <div class="topbar__greeting">
            Witaj <span th:text="${welcomeName}">Imię</span>, zdrowego dnia!
        </div>

        <nav class="nav">
            <a class="nav__link" th:href="@{/home}">Strona główna</a>
            <a class="nav__link" th:href="@{/profile}">Profil</a>
            <a class="nav__link" th:href="@{/status}">Status &amp; przegląd</a>
            <a class="nav__link" th:href="@{/medications}">Zarządzanie lekami</a>
            <a class="nav__link" th:href="@{/doctor}" sec:authorize="hasRole('DOCTOR')">Dla lekarza</a>
        </nav>

        <div class="user-menu">
            <button class="user-menu__btn" type="button" aria-haspopup="true" aria-expanded="false">
                <span class="user-menu__label">Ustawienia</span>
                <span class="user-menu__icon" aria-hidden="true">⚙️</span>
            </button>

            <div class="user-menu__dropdown" role="menu" aria-label="Ustawienia konta">
                <a class="user-menu__item" role="menuitem" href="/change-password">Zmień hasło</a>
                <form th:action="@{/logout}" method="post" class="user-menu__logout">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="user-menu__item user-menu__item--danger user-menu__btnlink">
                        Wyloguj się
                    </button>
                </form>
            </div>
        </div>
    </div>
</header>

<main class="cp-main">
    <div class="cp-overlay"></div>

    <section class="cp-card" role="dialog" aria-modal="true" aria-labelledby="cpTitle">
        <h1 id="cpTitle" class="cp-title">Zmień hasło</h1>
        <p class="cp-subtitle">Wpisz stare hasło i ustaw nowe.</p>

        <div class="cp-toast cp-toast--ok" th:if="${changed}">
            Hasło zostało zmienione ✅
        </div>

        <div class="cp-toast cp-toast--err" th:if="${error}" th:text="${error}">
            Błąd
        </div>

        <form class="cp-form" th:action="@{/change-password}" method="post" autocomplete="off">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div class="cp-row">
                <label class="cp-label" for="oldPassword">Stare hasło</label>
                <input class="cp-input" id="oldPassword" name="oldPassword" type="password" required>
            </div>

            <div class="cp-row">
                <label class="cp-label" for="newPassword">Nowe hasło</label>
                <input class="cp-input" id="newPassword" name="newPassword" type="password" required minlength="4">
            </div>

            <div class="cp-row">
                <label class="cp-label" for="newPassword2">Potwierdź nowe hasło</label>
                <input class="cp-input" id="newPassword2" name="newPassword2" type="password" required minlength="4">
            </div>

            <div class="cp-actions">
                <a class="cp-btn cp-btn--ghost" th:href="@{/profile}">Anuluj</a>
                <button class="cp-btn cp-btn--primary" type="submit">Zmień hasło</button>
            </div>
        </form>
    </section>
</main>

<script>
    // Walidacja na froncie: nowe hasła muszą się zgadzać (jak w register.html)
    (() => {
        const p1 = document.getElementById('newPassword');
        const p2 = document.getElementById('newPassword2');
        if (!p1 || !p2) return;

        function validate() {
            if (p2.value && p1.value !== p2.value) {
                p2.setCustomValidity("Hasła nie są takie same");
            } else {
                p2.setCustomValidity("");
            }
        }

        p1.addEventListener('input', validate);
        p2.addEventListener('input', validate);
        p2.form?.addEventListener('submit', validate);
    })();
</script>

</body>
</html>