<!--<!doctype html>-->
<!--<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">-->
<!--<head>-->
<!--    <meta charset="UTF-8"/>-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1"/>-->
<!--    <title>Aplikacja medyczna - Dla lekarza</title>-->
<!--    <link rel="stylesheet" th:href="@{/css/style.css}">-->
<!--    <link rel="stylesheet" th:href="@{/css/doctor.css}">-->
<!--</head>-->
<!--<body class="page-bg">-->

<!--<header class="topbar">-->
<!--    <div class="container topbar__inner">-->
<!--        <a class="brand" th:href="@{/home}">-->
<!--            <img class="brand__logo" th:src="@{/img/logo.jpg}" alt="YourMed" />-->
<!--        </a>-->

<!--        <div class="topbar__greeting">-->
<!--            Witaj <span th:text="${welcomeName}">Imię</span>, zdrowego dnia!-->
<!--        </div>-->

<!--        <nav class="nav">-->
<!--            <a class="nav__link" th:href="@{/home}">Strona główna</a>-->
<!--            <a class="nav__link" th:href="@{/profile}">Profil</a>-->
<!--            <a class="nav__link" th:href="@{/status}">Status &amp; przegląd</a>-->
<!--            <a class="nav__link" th:href="@{/medications}">Zarządzanie lekami</a>-->
<!--            <a class="nav__link nav__link&#45;&#45;active" th:href="@{/doctor}" sec:authorize="hasRole('DOCTOR')">Dla lekarza</a>-->
<!--        </nav>-->
<!--    </div>-->
<!--</header>-->

<!--<main class="doc">-->
<!--    <div class="container doc__container">-->
<!--        <section class="doc-panel">-->
<!--            <div class="doc-panel__inner">-->
<!--                <div class="doc-top">-->
<!--                    <div class="doc-title-pill">Lista pacjentów</div>-->
<!--                    <button class="doc-add-btn" type="button" id="openAddPatient">-->
<!--                        + Dodaj pacjenta-->
<!--                    </button>-->
<!--                </div>-->

<!--                <div class="doc-table">-->
<!--                    <div class="doc-head">-->
<!--                        <div class="doc-pill doc-pill&#45;&#45;small">Id</div>-->
<!--                        <div class="doc-pill">Imię i nazwisko</div>-->
<!--                        <div class="doc-pill">Ostatnia wizyta</div>-->
<!--                        <div class="doc-pill">Przyjmowane leki</div>-->
<!--                    </div>-->

<!--                    <div class="doc-body" th:if="${!#lists.isEmpty(patients)}">-->
<!--                        <div class="doc-row"-->
<!--                             th:each="p : ${patients}"-->
<!--                             th:attr="data-pid=${p.id}, data-last=${p.lastVisitIso}">-->
<!--                            <div class="doc-cell doc-cell&#45;&#45;id" th:text="${p.id}">1</div>-->
<!--                            <div class="doc-cell" th:text="${p.fullName}">Jan Kowalski</div>-->
<!--                            <div class="doc-cell">-->
<!--                                <span class="doc-last-text" th:text="${p.lastVisitDisplay}">-</span>-->
<!--                                <input class="doc-last-input" type="date" th:value="${p.lastVisitIso}" disabled>-->
<!--                            </div>-->
<!--                            <div class="doc-cell">-->
<!--                                <a class="doc-link" th:href="@{/medications(patientId=${p.id})}">-->
<!--                                    Lista leków-->
<!--                                </a>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </section>-->
<!--    </div>-->
<!--</main>-->

<!--<script>-->
<!--    (() => {-->
<!--        // ===== wybór pacjenta + edycja lastVisit =====-->
<!--        const rows = [...document.querySelectorAll('.doc-row')];-->
<!--        const editBtn = document.getElementById('editBtn');-->
<!--        const cancelBtn = document.getElementById('cancelBtn');-->
<!--        const saveBtn = document.getElementById('saveBtn');-->

<!--        const visitForm = document.getElementById('visitForm');-->
<!--        const visitPatientId = document.getElementById('visitPatientId');-->
<!--        const visitLastVisit = document.getElementById('visitLastVisit');-->

<!--        let selectedRow = null;-->
<!--        let initialDate = '';-->

<!--        function clearSelection(){-->
<!--            rows.forEach(r => r.classList.remove('is-active'));-->
<!--            selectedRow = null;-->
<!--            editBtn.disabled = true;-->
<!--        }-->

<!--        function selectRow(row){-->
<!--            rows.forEach(r => r.classList.remove('is-active'));-->
<!--            row.classList.add('is-active');-->
<!--            selectedRow = row;-->
<!--            editBtn.disabled = false;-->

<!--            const input = row.querySelector('.doc-last-input');-->
<!--            initialDate = input?.value ?? '';-->
<!--        }-->

<!--        function setEditing(on){-->
<!--            if (!selectedRow) return;-->
<!--            selectedRow.classList.toggle('is-editing', on);-->

<!--            const input = selectedRow.querySelector('.doc-last-input');-->
<!--            const text = selectedRow.querySelector('.doc-last-text');-->
<!--            if (input) input.disabled = !on;-->

<!--            if (text) text.style.display = on ? 'none' : '';-->
<!--            if (input) input.style.display = on ? '' : 'none';-->

<!--            editBtn.hidden = on;-->
<!--            cancelBtn.hidden = !on;-->
<!--            saveBtn.hidden = !on;-->
<!--        }-->

<!--        rows.forEach(r => {-->
<!--            r.addEventListener('click', () => selectRow(r));-->
<!--        });-->

<!--        editBtn?.addEventListener('click', () => setEditing(true));-->

<!--        cancelBtn?.addEventListener('click', () => {-->
<!--            if (!selectedRow) return;-->
<!--            const input = selectedRow.querySelector('.doc-last-input');-->
<!--            const text = selectedRow.querySelector('.doc-last-text');-->
<!--            if (input) input.value = initialDate;-->
<!--            if (text) text.textContent = initialDate ? initialDate : '-';-->
<!--            setEditing(false);-->
<!--        });-->

<!--        saveBtn?.addEventListener('click', () => {-->
<!--            if (!selectedRow) return;-->
<!--            const pid = selectedRow.getAttribute('data-pid');-->
<!--            const input = selectedRow.querySelector('.doc-last-input');-->
<!--            const val = input?.value ?? '';-->

<!--            visitPatientId.value = pid;-->
<!--            visitLastVisit.value = val;-->
<!--            visitForm.submit();-->
<!--        });-->
<!--    })();-->
<!--</script>-->

<!--</body>-->
<!--</html>-->

<!doctype html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Aplikacja medyczna - Dla lekarza</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/doctor.css}">
</head>
<body class="page-bg">

<header class="topbar">
    <div class="container topbar__inner">
        <a class="brand" th:href="@{/home}">
            <img class="brand__logo" th:src="@{/img/logo.jpg}" alt="YourMed" />
        </a>

        <div class="topbar__greeting">
            Witaj <span th:text="${welcomeName}">Imię</span>, zdrowego dnia!
        </div>

        <nav class="nav">
            <a class="nav__link" th:href="@{/home}">Strona główna</a>
            <a class="nav__link" th:href="@{/profile}">Profil</a>
            <a class="nav__link" th:href="@{/status}">Status &amp; przegląd</a>
            <a class="nav__link" th:href="@{/medications}">Zarządzanie lekami</a>
            <a class="nav__link nav__link--active" th:href="@{/doctor}" sec:authorize="hasRole('DOCTOR')">Dla lekarza</a>
        </nav>
    </div>
</header>

<main class="doc">
    <div class="container doc__container">
        <section class="doc-panel">
            <div class="doc-panel__inner">
                <div class="doc-top">
                    <div class="doc-title-pill">Lista pacjentów</div>
                    <button class="doc-add-btn" type="button" id="openAddPatient">
                        + Dodaj pacjenta
                    </button>
                </div>

                <div class="doc-table">
                    <div class="doc-head">
                        <div class="doc-pill doc-pill--small">Id</div>
                        <div class="doc-pill">Imię i nazwisko</div>
                        <div class="doc-pill">Ostatnia wizyta</div>
                        <div class="doc-pill">Przyjmowane leki</div>
                    </div>

                    <div class="doc-body" th:if="${!#lists.isEmpty(patients)}">
                        <div class="doc-row"
                             th:each="p : ${patients}"
                             th:attr="data-pid=${p.id}, data-last=${p.lastVisitIso}">
                            <div class="doc-cell doc-cell--id" th:text="${p.id}">1</div>
                            <div class="doc-cell" th:text="${p.fullName}">Jan Kowalski</div>
                            <div class="doc-cell">
                                <span class="doc-last-text" th:text="${p.lastVisitDisplay}">-</span>
                                <input class="doc-last-input" type="date" th:value="${p.lastVisitIso}" disabled>
                            </div>
                            <div class="doc-cell">
                                <a class="doc-link" th:href="@{/medications(patientId=${p.id})}">
                                    Lista leków
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<script>
    (() => {
        const rows = [...document.querySelectorAll('.doc-row')];
        const editBtn = document.getElementById('editBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');

        const visitForm = document.getElementById('visitForm');
        const visitPatientId = document.getElementById('visitPatientId');
        const visitLastVisit = document.getElementById('visitLastVisit');

        let selectedRow = null;
        let initialDate = '';

        function clearSelection(){
            rows.forEach(r => r.classList.remove('is-active'));
            selectedRow = null;
            editBtn.disabled = true;
        }

        function selectRow(row){
            rows.forEach(r => r.classList.remove('is-active'));
            row.classList.add('is-active');
            selectedRow = row;
            editBtn.disabled = false;

            const input = row.querySelector('.doc-last-input');
            initialDate = input?.value ?? '';
        }

        function setEditing(on){
            if (!selectedRow) return;
            selectedRow.classList.toggle('is-editing', on);

            const input = selectedRow.querySelector('.doc-last-input');
            const text = selectedRow.querySelector('.doc-last-text');
            if (input) input.disabled = !on;

            if (text) text.style.display = on ? 'none' : '';
            if (input) input.style.display = on ? '' : 'none';

            editBtn.hidden = on;
            cancelBtn.hidden = !on;
            saveBtn.hidden = !on;
        }

        rows.forEach(r => {
            r.addEventListener('click', () => selectRow(r));
        });

        editBtn?.addEventListener('click', () => setEditing(true));

        cancelBtn?.addEventListener('click', () => {
            if (!selectedRow) return;
            const input = selectedRow.querySelector('.doc-last-input');
            const text = selectedRow.querySelector('.doc-last-text');
            if (input) input.value = initialDate;
            if (text) text.textContent = initialDate ? initialDate : '-';
            setEditing(false);
        });

        saveBtn?.addEventListener('click', () => {
            if (!selectedRow) return;
            const pid = selectedRow.getAttribute('data-pid');
            const input = selectedRow.querySelector('.doc-last-input');
            const val = input?.value ?? '';

            visitPatientId.value = pid;
            visitLastVisit.value = val;
            visitForm.submit();
        });
    })();
</script>

</body>
</html>
